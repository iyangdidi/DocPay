<!DOCTYPE html>
<!--[if IE 8]><html class="ie ie8"><![endif]-->
<!--[if IE 9]><html class="ie ie9"><![endif]-->
<!--[if !IE]><!--> <html> <!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no" />
  <!-- <link href="favicon.ico" rel="icon" /> -->
  <link rel="stylesheet" media="all" href="css/reset.css" />
  <link rel="stylesheet" media="all" href="css/common.css" />
  <link rel="stylesheet" media="all" href="css/account.css" />
  <title>修改账户信息</title>
 </head>
 <body>
 	<!-- 全局顶部栏 -->
 	<div class="m-navbar" role="navigation">
  		<div class="limit clearfix">
	    	<a class="logo icon icon-logo fl" href="/"></a>
	    	<div class="fr login-box" >
	    		<i class="icon icon-login_icon"></i>
	    		<a class="sign-up" href="/register">注册</a> /
	        	<a class="log-in" href="/login">登录</a>
	    	</div>
	    	<div class="fr login-box logged-in" style="display: none">
	    		<a href="/record_list" class="record"><i class="icon icon-record_icon"></i>购买记录</a>
	    		<span class="name"><a href="/modify_account">--</a>，已登录</span>
				<a href="/modify_account"><i class="icon icon-islogin_icon"></i></a>
	    	</div>
     	</div>
    </div>
    <!-- end -->

    <div class="wrap">
	    <!-- 内容 -->
	    <div class="u-content-wrap register-wrap modify-account-wrap">
	    	<div class="header clearfix">
	    		<p class="u-title fl"><i></i>骨朵账号登录</p>
	    		<a href="/" class="go-home fr">&lt;&lt; 返回首页</a>
	    	</div>
	    	<div class="body bd-b">
				<div class="alert alert-success"></div>
				<div class="alert alert-danger"></div>
	    		<div class="password-box m-form">
	    			<div class="form-group clearfix">
	    				<label for="" class="control-label">手机号</label>
					    <div class="control-input">
					       <span><em id="user-phone">-----------</em>&nbsp;&nbsp;（不可更换）</span>
					    </div>
					</div>
					<div class="form-group clearfix" style="margin-bottom: 52px">
						<label for="" class="control-label">密&nbsp;&nbsp;码</label>
					    <div class="control-input">
					       <span>********</span>
					       <button type="button" class="btn modify-btn">点击修改</button>
					    </div>
	    			</div>
	    			<div class="modify-box" style="display: none">
		    			<div class="form-group clearfix">
							<label for="" class="control-label" style="padding-top: 11px">验证码</label>
						    <div class="control-input">
						       <input type="text" class="form-control" id="captcha" name="captcha" placeholder="请输入验证码" />
						       <button class="captcha-btn" id="sendCaptcha" name="sendCaptcha" type="button">获取验证码</button>
						    </div>
		    			</div>
		    			<div class="form-group clearfix password-group" style="margin-top: -26px">
							<label for="password" class="control-label" style="padding-top:26px">新密码</label>
						    <div class="control-input">
						       <input type="password" class="form-control" id="password" name="password" placeholder="请输入新密码" title="" maxlength="20" />
						    </div>
		    			</div>
	    			</div>
	    		</div>
	    		<form method="post" action="" id="modifyForm" class="m-form">
	    			<div class="form-group clearfix">
				    	<label for="username" class="control-label">姓&nbsp;&nbsp;&nbsp;名</label>
					    <div class="control-input">
					       <input type="text" class="form-control" id="username" name="username" placeholder="请输入姓名" data-msg=" " />
					    </div>
					    
				  	</div>
				  	<div class="form-group clearfix">
				    	<label for="email" class="control-label">邮&nbsp;&nbsp;&nbsp;箱</label>
					    <div class="control-input">
					       <input type="text" class="form-control" id="email" name="email" placeholder="请输入邮箱" data-msg=" " />
					    </div>
				  	</div>
	    			<div class="form-group clearfix">
				    	<label for="company" class="control-label">公&nbsp;&nbsp;&nbsp;司</label>
					    <div class="control-input">
					       <input type="text" class="form-control" id="company" name="company" placeholder="请输入您的公司" data-msg=" " />
					    </div>
				  	</div>
				  	<div class="form-group clearfix">
				    	<label for="position" class="control-label">职&nbsp;&nbsp;&nbsp;位</label>
					    <div class="control-input choose-pos-box">
					        <div class="choose-pos">请选择您的职位<em class="arrow icon icon-arrow_b"></em></div>
					        <ul class="position-list" style="display: none">
					       	    <li class="odd">导演/编导</li>
					       	    <li class="even"></li>
					       	    <li class="odd">作家/编剧</li>
					       	    <li class="even"></li>
					       	    <li class="odd">经纪人/艺人</li>
					       	    <li class="even"></li>
					       	    <li class="odd">文案/策划</li>
					       	    <li class="even"></li>
					       	    <li class="last odd">公关/媒介</li>
					        </ul>
					       <input type="hidden" id="position" name="position" value="" />
					    </div>
				  	</div>
				  	<input type="hidden" name="passwordVal" id="passwordVal" value="" />
				  	<input type="hidden" id="phone" name="phone" value="" />
	    			<button class="btn next-btn" type="submit">确认更改</button>
	    		</form>
	    		
	    	</div>
	    	<div class="foot"></div>
	    </div>
	    <!-- end -->
    </div>
    <script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/account_validate.js"></script>
    <script type="text/javascript" src="js/jquery.validate.min.js"></script>
    <script type="text/javascript" src="js/messages_zh.js"></script>
	<script type="text/javascript">
		var sendCaptchaObj = {
			InterValObj : null,
			count : 60,
			curCount : 0,
			isSend : false,
			code : 0,
			setRemainTime : function() {
				if (sendCaptchaObj.curCount == 0) {
					window.clearInterval(sendCaptchaObj.InterValObj);
					$("#sendCaptcha").removeAttr("disabled").removeClass('disabled').text("重新发送");
				} else {
					sendCaptchaObj.curCount--;
					$("#sendCaptcha").text(sendCaptchaObj.curCount + " s");
				}
			},
			send : (function(){
				$("#sendCaptcha").on("click",function(event){
					event.preventDefault();
					var phone = $("#user-phone").text();
					if(phone.length !== 11){
						return;
					}
					sendCaptchaObj.curCount = sendCaptchaObj.count;
					//设置button效果，开始计时
					$("#sendCaptcha").attr("disabled", "true").addClass('disabled');
					$("#sendCaptcha").text(sendCaptchaObj.curCount + " s");
					sendCaptchaObj.InterValObj = window.setInterval(sendCaptchaObj.setRemainTime, 1000);
                    $.ajax({
                        type : "post",
                        url : "/vcode/send?t=" + new Date().getTime(),
                        data : {
                            phone : phone,
                        },
                        dataType : "json",
                        success : function(data) {
                            if(data.code == 0){
                                sendCaptchaObj.isSend = true
                            }
                        }
                    });
				});
			})()
		};

		var setUserInfo = function () {
		    try{
		        if(window.localStorage){
                    var userinfo = JSON.parse(localStorage.getItem("userinfo"));
					$("#user-phone").text(userinfo.phoneNumber);
					$("#username").val(userinfo.nickName);
                    $("#email").val(userinfo.email);
                    $("#company").val(userinfo.company);
                    $(".choose-pos").html(userinfo.job +'<em class="arrow icon icon-arrow_b"></em>');
                    $("#position").val(userinfo.job);
				}

			}catch (e){
		        var token = $.cookie('userToken');
                $.ajax({
                    type : "post",
                    url : "/user/get?t=" + new Date().getTime(),
                    dataType : "json",
                    data : {
                        token : token,
                    }
                })
				.done(function ( data ) {
					if(data.code == '0'){
                        $("#user-phone").text(data.data.phoneNumber);
                        $("#username").val(data.data.nickName);
                        $("#email").val(data.data.email);
                        $("#company").val(data.data.company);
                        $(".choose-pos").html(data.data.job +'<em class="arrow icon icon-arrow_b"></em>');
                        $("#position").val(data.data.job);
					}
				})
				.fail(function (jqXHR, textStatus,errorThrown) {
					console.log(jqXHR);
				});
			}

        }();
			
		function baseModify(phone,token,nickName,email,position,company) {
            $.ajax({
                type : "post",
                url : "/user/perfectInfo?t=" + new Date().getTime(),
                dataType : "json",
                data : {
                    userName: phone,
                    token: token,
                    nickName : nickName,
                    email : email,
                    job : position,
                    company:company
                }
            })
			.done(function ( data ) {
				if(data.code == '0'){
					$(".logged-in .name a").text(nickName);
					$(".alert-success").text("修改成功").show();
				}else{
					$(".alert-danger").text("修改失败").show();
				}
			})
			.fail(function (jqXHR, textStatus,errorThrown) {
				console.log(jqXHR);
			});
        }

        function allModify(phone,code,password) {
            $.ajax({
                type : "post",
                url : "/user/resetPassword?t=" + new Date().getTime(),
                dataType : "json",
                data : {
                    phone: phone,
                    code:code,
                    newPassword:password
                }
            })
			.done(function ( data ) {
				$(".password-box").css("top",91);
				if(data.code == '0'){
					$(".alert-success").text(data.message).show();
				}else{
					$(".alert-danger").text(data.message).show();
				}
			})
			.fail(function (jqXHR, textStatus,errorThrown) {
				console.log(jqXHR);
			});
        }

		$(function(){

			$("#modifyForm").validate({
				debug: true,
				ignore: ".ignore",
				focusCleanup: true,
				focusInvalid : true,
				errorElement: "i",
				errorClass: "error",
			    errorContainer: $(".form-group i"),
			    errorPlacement: function(error, element) {
			      error.appendTo(element.parents(".form-group"));
			      error.removeClass('success');
			    },
			    validClass: "success",
			    success: function(element) {
			      element.addClass("success");
			    },
				rules:{
					username: {
						required: true,
					},
					email: {
						required: true,
						email: true
					},
					company: {
						required: true,
					},
				    position: {
				      	required: true,
				    },
				    passwordVal:{
				    	required: $(".modify-box").css("display") !== "none",
                        matchPassword: true,
				    	rangelength: [6,20]
				    }
				},

			    submitHandler: function(form){
                    if(!$("#modifyForm").valid()){
                        return;
                    };

                    var pw = /^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,12}$/;
                    var nickName = $("#username").val(),email = $("#email").val(),company = $("#company").val(),position = $("#position").val(),phone = $.cookie('userPhone'),token = $.cookie('userToken'),password = $("#password").val(),code=$("#captcha").val();

                    if($(".modify-box").css("display") == "none"){
                        baseModify(phone,token,nickName,email,position,company);
                    }else if(pw.test($("#password").val())){
                        baseModify(phone,token,nickName,email,position,company);
                        allModify(phone,code,password);
					}else{
                        $(".password-group").append('<i class="error" style="right:-45px"></i>');
                        return false;
                    }

                }
			});

			
			
			$(".modify-btn").on("click",function(){
				$(".password-box").animate({top: 28}, 500);
				$(".modify-box").fadeIn(600);
				$(this).hide();
			});

			var showPosition = (function(){
				var show = function(){
					$(".choose-pos").on("click",function(){
						window.event? window.event.cancelBubble = true : e.stopPropagation();
						$(".position-list").slideDown(400);
					});
				};
				var hide = function(){
					$("body").on("click",function(e){
						$(".position-list").slideUp(400);
					});
				}
				var choose = function(){
					$(".position-list li.odd").on("click",function(){
						var position = $(this).text();
						$('#position').val(position);
						$(".choose-pos").text(position);
						$("#modifyForm").valid();
					});
				}
				return {
					clickPos:show(),
					hidePos:hide(),
					choosePos:choose()
				}
			})()
			
			showPosition.clickPos;
			showPosition.hidePos;
			showPosition.choosePos;

		})
	</script>
 </body>
 </html>